---
- hosts: master

  vars:
    bushslicer_env:
      BUSHSLICER_DEFAULT_ENVIRONMENT: 'ose'
      OPENSHIFT_ENV_OSE_USER_MANAGER_USERS: 'system:admin,developer:developer'
      OPENSHIFT_ENV_OSE_HOSTS: 'localhost:8443:etcd:master:node'
      OPENSHIFT_ENV_ORIGIN_USER_MANAGER_USERS: 'system:admin,developer:developer'
      OPENSHIFT_ENV_ORIGIN_HOSTS: 'localhost:8443:etcd:master:node'
      BUSHSLICER_DEBUG_AFTER_FAIL: 'false'
      BUSHSLICER_HOME: '~/bushslicer'
    output_dir: "reports/{{ ansible_architecture }}"
    ENABLE_SMOKE_TESTS: true

  tasks:
    - file:
        path: "{{ output_dir }}"
        state: directory
        mode: 0755
        recurse: true

    - shell: "bash -lc \"scl enable rh-git29 -- cucumber -p junit --format junit features/cli/create.feature -o ../{{ output_dir }}/cli_create-feature.xml\""
      args:
        chdir: verification-tests
        executable: /bin/bash
        creates: "{{ output_dir }}/cli_create-feature.xml"
      ignore_errors: yes
      environment: "{{ bushslicer_env }}"

    - shell: "bash -lc \"scl enable rh-git29 -- cucumber -p junit --format junit features/web/build.feature -o ../{{ output_dir }}/web_build-feature.xml\""
      args:
        chdir: verification-tests
        executable: /bin/bash
        creates: "{{ output_dir }}/web_build-feature.xml"
      ignore_errors: yes
      environment: "{{ bushslicer_env }}"

    - shell: "bash -lc \"scl enable rh-git29 -- cucumber -p junit --tags @smoke --format junit -o ../{{ output_dir }}/smoke-feature.xml\""
      args:
        chdir: verification-tests
        executable: /bin/bash
        creates: "{{ output_dir }}/smoke-tests.xml"
      when: ENABLE_SMOKE_TESTS is defined
      ignore_errors: yes
      environment: "{{ bushslicer_env }}"
