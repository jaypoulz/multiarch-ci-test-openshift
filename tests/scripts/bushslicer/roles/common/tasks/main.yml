---
- name: upgrade all packages
  yum:
    name: '*'
    state: latest
  become: yes

- name: install pre-req packages
  yum:
    name: 'wget, yum-utils, python-docker-py, iptables-services, skopeo, dnsmasq, conntrack-tools, docker, rh-git29'
    state: latest
  become: yes

- name: append the insecure registry
  lineinfile:
    path: /etc/sysconfig/docker
    regexp: '^INSECURE_REGISTRY='
    line: "INSECURE_REGISTRY='--insecure-registry 172.30.0.0/16{% if INSECURE_REGISTRY_HOSTNAME %} --insecure-registry {{ INSECURE_REGISTRY_HOSTNAME }}:{{ INSECURE_REGISTRY_PORT }}{% endif %}'"
  become: yes

- name: enable, reload, and restart docker service post adding insecure registries
  systemd:
    name: docker
    enabled: true
    state: restarted
    daemon_reload: yes
  become: yes

- name: ensure artifact dir exists
  file: path={{ playbook_dir }}/artifacts state=directory

- name: create the inventory playbook
  template:
    src: "{{ playbook_dir }}/templates/host.inventory.j2"
    dest: "{{ playbook_dir }}/artifacts/host.inventory"
    mode: 0644
